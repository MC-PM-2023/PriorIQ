{% extends "base.html" %}
{% block title %}PriorIQ - Log{% endblock %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
  :root{
    --bg1:#253746; --bg2:#4b9aaa;
    --head:#1f2b37; --headTxt:#fff;
    --rowOdd:#ffffff; --rowEven:#f8fafc; --hover:#eef7ff;
    --border:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,.15);
    --app-header-h: 64px;
    --card-pad: 24px;
    --footer-h: 40px;
  }

  html, body{ height:100%; overflow:hidden; background:#10161d; }

  .logs-wrap{
    max-width:90%;
    height: calc(100dvh - var(--app-header-h) - var(--card-pad) - var(--footer-h));
    margin: var(--card-pad) auto 0;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    border-radius:14px;
    box-shadow:var(--shadow);
    padding: var(--card-pad);
    color:#eaf2f7;
    display:flex; flex-direction:column; gap:10px; min-height:0;
  }

  .logs-title{
    text-align:center; font-weight:800; font-size:42px; color:#fff;
    margin:0 0 6px 0; flex:0 0 auto;
  }

  .table-container{
    position:relative; flex:1 1 auto; min-height:0; overflow:auto;
    background:#fff; border-radius:10px; border:1px solid var(--border);
    padding-bottom:8px; scrollbar-gutter:stable;
  }
  .table-container::-webkit-scrollbar{height:10px;width:10px}
  .table-container::-webkit-scrollbar-thumb{background:#94a3b8;border-radius:8px}
  .table-container::-webkit-scrollbar-track{background:transparent}

  table.logs-table{ width:100%; border-collapse:separate; border-spacing:0; font-size:.92rem; }

  .logs-table thead tr:first-child th{
    position:sticky; top:0; z-index:12;
    background:var(--head)!important; color:var(--headTxt);
    font-weight:700; border-bottom:1px solid #314052!important;
    padding:10px 10px!important; white-space:nowrap;
    box-shadow:0 1px 0 #314052;
    text-align:center;
  }

  .logs-table thead tr.filter-row th{
    position:sticky; top:var(--sticky-offset,44px); z-index:11;
    background:#233240!important; border-bottom:1px solid #2e3f52!important; padding:6px 8px!important;
    text-align:center;
  }

  .logs-table tbody td{
    border-top:1px solid var(--border)!important;
    padding:10px 10px!important; vertical-align:middle; color:#0f172a; white-space:nowrap;
  }
  .logs-table tbody tr:nth-child(odd){ background:var(--rowOdd); }
  .logs-table tbody tr:nth-child(even){ background:var(--rowEven); }
  .logs-table tbody tr:hover{ background:var(--hover); }

  .col-filter{
    display:inline-block;
    background:#fff; border:1px solid #cbd5e1; border-radius:6px;
    height:28px; font-size:.8rem; padding:1px 6px;
    width:auto; min-width:90px; max-width:120px;
  }

  .td-truncate{
    max-width:260px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    cursor:help;
  }

  /* right-align numeric cells (applied by JS) */
  .num { text-align:right; }

  .bottombar{
    display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    color:#e6f1f7; flex:0 0 auto;
  }
  .pager .page-link{ border-radius:6px; color:#17395d; font-weight:600; font-size:.9rem; }
  .pager .disabled .page-link{ color:#9ca3af; }

  .app-footer-fixed{
    position:fixed; bottom:0; height:var(--footer-h);
    display:flex; align-items:center; justify-content:center;
    font-weight:700; font-size:13px; color:#e6f1f7;
    background: rgba(15,23,42,.72);
    border-top:1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(6px);
    z-index:999;
  }

  /* 2-line tooltip */
  .tooltip.wrap2-tip .tooltip-inner{
    max-width: 560px;
    white-space: normal;
    word-break: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-align: left;
    line-height: 1.2;
  }
</style>



<div class="logs-wrap">
  <h1 class="logs-title">Execution Logs</h1>

  <div class="table-container">
    {% if table %}
      {{ table|safe }}
    {% else %}
      <div class="p-3 text-center text-light">No logs found.</div>
    {% endif %}
  </div>

  <div class="bottombar">
    <div id="showingInfo" class="small"></div>
    <nav class="pager">
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item {% if page==1 %}disabled{% endif %}">
          <a class="page-link" href="{{ prev_url }}">Previous</a>
        </li>
        <li class="page-item disabled"><span class="page-link">{{ page }}</span></li>
        <li class="page-item {% if page==total_pages %}disabled{% endif %}">
          <a class="page-link" href="{{ next_url }}">Next</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<div id="pageFooter" class="app-footer-fixed">© Datasolve Analytics Pvt Ltd 2025.</div>

<script>
(function(){
  const tbl = document.querySelector('.logs-table');
  if(!tbl) return;

  const thead = tbl.querySelector('thead');

  /* map header text -> column index */
  function headerIndexMap(table){
    const map = {};
    const heads = Array.from(table.querySelectorAll('thead tr:first-child th'));
    heads.forEach((th, idx) => { map[th.textContent.trim().toLowerCase()] = idx; });
    return map;
  }

  /* ===== 1) format numbers BEFORE building filter row ===== */
  function formatNumericColumns(table, columns){
    const hmap = headerIndexMap(table);
    const idxs = columns.map(c => hmap[c.toLowerCase()]).filter(i => Number.isInteger(i));
    if (!idxs.length) return;

    table.querySelectorAll('tbody tr').forEach(tr=>{
      idxs.forEach(i=>{
        const td = tr.cells[i]; if(!td) return;
        let txt = (td.textContent || '').trim();

        // blank out NaN-like values
        if (/^(nan|null|none)$/i.test(txt) || txt === '') {
          td.textContent = '';
          td.classList.add('num');
          return;
        }

        // parse number and remove trailing .0
        const num = Number(txt.replace(/,/g,''));
        if (Number.isFinite(num)) {
          const asInt = Number.isInteger(num) ? num : (Number.isInteger(num*10) && String(num).endsWith('.0') ? Math.trunc(num) : num);
          td.textContent = Number.isInteger(asInt) ? String(asInt) : String(num);
          td.classList.add('num');
        }
      });
    });
  }

  // Run numeric formatting for these two columns
  formatNumericColumns(tbl, ['Initial Rows','Final Rows']);

  /* compute sticky offset after header exists */
  if (thead && thead.rows.length) {
    const headerRowHeight = thead.rows[0].getBoundingClientRect().height || 44;
    tbl.style.setProperty('--sticky-offset', headerRowHeight + 'px');
  }

  /* ===== 2) tooltips for long text columns ===== */
  const TRUNCATE_COLUMNS = ['Abstract','Upload File Name','Downloadfile Name','Status'];

  function applyTruncationAndTooltips(table){
    const hmap = headerIndexMap(table);
    const targetIdx = TRUNCATE_COLUMNS
      .map(n => hmap[n.toLowerCase()])
      .filter(i => Number.isInteger(i));

    table.querySelectorAll('tbody tr').forEach(tr => {
      targetIdx.forEach(i => {
        const td = tr.cells[i]; if(!td) return;
        const full = (td.textContent || '').trim();
        td.classList.add('td-truncate');
        td.setAttribute('title', full);
        td.setAttribute('data-bs-toggle','tooltip');
        td.setAttribute('data-bs-placement','top');
        td.setAttribute('data-bs-custom-class','wrap2-tip');
      });
    });

    const tooltipEls = [].slice.call(table.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipEls.forEach(el => new bootstrap.Tooltip(el, { boundary: document.body }));
  }
  applyTruncationAndTooltips(tbl);

  /* ===== 3) build filter row (after formatting so options match) ===== */
  const headers = Array.from(thead.querySelectorAll('th')).map(th => th.textContent.trim());
  const ftr = document.createElement('tr'); ftr.className = 'filter-row';
  headers.forEach((h, idx)=>{
    const th=document.createElement('th'); th.style.textAlign='center';
    const sel=document.createElement('select');
    sel.className='col-filter';
    sel.innerHTML='<option value="">All</option>';
    const vals=new Set();
    tbl.querySelectorAll('tbody tr').forEach(tr=>{
      const td=tr.cells[idx];
      if(td) vals.add((td.textContent||'').trim());
    });
    [...vals].sort((a,b)=>a.localeCompare(b)).forEach(v=>{
      const o=document.createElement('option'); o.value=v; o.textContent=v||'—'; sel.appendChild(o);
    });
    sel.addEventListener('change',filterTable);
    th.appendChild(sel);
    ftr.appendChild(th);
  });
  thead.appendChild(ftr);

  function filterTable(){
    const filters=Array.from(document.querySelectorAll('.filter-row .col-filter'));
    tbl.querySelectorAll('tbody tr').forEach(tr=>{
      let show=true;
      filters.forEach((sel,i)=>{
        const v=sel.value;
        const cell=tr.cells[i]?tr.cells[i].textContent.trim():'';
        if(v && v!==cell) show=false;
      });
      tr.style.display=show?'':'none';
    });
    updateInfo();
  }

  function updateInfo(){
    const perPage={{ per_page|int }}, page={{ page|int }}, total={{ total|int }};
    const rows=Array.from(tbl.querySelectorAll('tbody tr')).filter(r=>r.style.display!=='none');
    const start=(page-1)*perPage + (rows.length ? 1 : 0);
    const end=(page-1)*perPage + rows.length;
    const el = document.getElementById('showingInfo');
    if(el) el.textContent = `Showing ${rows.length?start:0} to ${rows.length?end:0} of ${total} entries`;
  }
  updateInfo();

  /* footer aligns to content width */
  const footer = document.getElementById('pageFooter');
  function positionFooter(){
    const wrap = document.querySelector('.logs-wrap');
    if(!wrap) return;
    const r = wrap.getBoundingClientRect();
    footer.style.left  = r.left + 'px';
    footer.style.width = r.width + 'px';
  }
  positionFooter();
  window.addEventListener('resize', positionFooter);
})();
</script>
{% endblock %}
