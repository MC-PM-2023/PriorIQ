{% extends "base.html" %}
{% block content %}
<style>
  :root{
    /* Core */
    --panel: rgba(10,16,28,0.72);
    --edge: rgba(0,255,255,0.12);
    --text:#d9f6ff;
    --muted:#8fb8c5;
    --hint:#6aa0b0;
    --primary:#00e5ff;
    --accent:#7c4dff;

    /* Layout + sizing */
    --header-height:35px;
    --shell-pad: clamp(14px, 2vw, 24px);
    --card-pad: clamp(16px, 2vw, 22px);
    --tile-radius: 14px;
    --gif-h: clamp(80px, 1vw, 120px);
    --gif-inset: 5px;

    /* Fine tune: move card slightly up */
    --card-shift-up: clamp(12px, 2.2vh, 36px);

    /* Animation */
    --pulse-speed: 2.4s;
  }

  *{box-sizing:border-box; user-select:none}

  /* ðŸ”’ Disable OUTER scroll completely */
  html, body{
    height:100%;
    margin:0;
    background:#000;
    overflow:hidden;
    overscroll-behavior:none;
  }

  .stage{
    position:relative;
    height:calc(100vh - var(--header-height));
    overflow:hidden;
    padding:0;
  }

  /* Background video + veil (overscanned to remove edge gaps) */
  .bg-video{
    position:fixed;
    inset:-8px;
    width:calc(100% + 16px);
    height:calc(100% + 16px);
    object-fit:cover;
    filter:brightness(.8) contrast(1.08) saturate(1.05);
    z-index:0;
    pointer-events:none;
  }
  .veil{
    position:fixed;
    inset:-8px;
    z-index:1;
    pointer-events:none;
    background:
      radial-gradient(1200px 600px at 80% 20%, rgba(124,77,255,.15), transparent 55%),
      radial-gradient(1000px 500px at 20% 80%, rgba(0,229,255,.12), transparent 60%);
  }

  .shell{
    position:relative; z-index:2; height:100%; width:100%;
    display:grid; place-items:center;
    /* safe-area padding moved here; add bottom pad so footer won't overlap */
    padding:
      calc(var(--shell-pad) + env(safe-area-inset-top))
      calc(var(--shell-pad) + env(safe-area-inset-right))
      calc(var(--shell-pad) + env(safe-area-inset-bottom) + 60px)
      calc(var(--shell-pad) + env(safe-area-inset-left));
  }

  .card{
    width:min(940px, 96vw);
    background:var(--panel); border:1px solid var(--edge);
    border-radius:18px; backdrop-filter:blur(10px);
    padding:var(--card-pad);
    box-shadow:0 6px 28px rgba(0,0,0,.55);
    animation:cardIn .35s ease;
    /* âœ… shift the card a bit upwards */
    transform: translateY(calc(-1 * var(--card-shift-up)));
  }
  @keyframes cardIn{from{opacity:0; transform:translateY(calc(6px - var(--card-shift-up)))} to{opacity:1; transform:translateY(calc(-1 * var(--card-shift-up)))}}

  .head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
  .title{display:flex; align-items:center; gap:8px; color:#fff; font-weight:800; font-size:18px}
  .title .dot{width:9px; height:9px; border-radius:50%; background:linear-gradient(135deg,var(--primary),var(--accent)); box-shadow:0 0 14px rgba(0,229,255,.55)}
  .badge{font-size:11px; color:var(--muted); border:1px solid var(--edge); border-radius:999px; padding:5px 8px; background:rgba(255,255,255,.02)}

  form{display:grid; gap:14px}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:start;}
  @media (max-width:768px){ .row{grid-template-columns:1fr} }
  .field{display:grid; grid-template-rows:auto auto auto; gap:6px; min-width:0;}
  label{color:var(--muted); font-size:12px; margin:0}
  .control{
    background:rgba(0,0,0,.5); color:var(--text);
    border:1px solid rgba(0,229,255,.18); border-radius:12px;
    padding:10px 11px; font-size:14px; outline:none;
    transition:box-shadow .2s, border-color .2s, background .2s;
  }
  .control:hover{background:rgba(0,0,0,.55)}
  .control:focus-visible{box-shadow:0 0 0 3px rgba(0,229,255,.25); border-color:rgba(124,77,255,.5)}
  textarea.control{min-height:120px; resize:vertical}
  .help{color:var(--hint); font-size:12px}

  .filebox{display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px;
    background:rgba(0,0,0,.5); border:1px dashed rgba(0,229,255,.22)}
  .filebox input[type=file]{display:none}
  .filebtn{
    padding:8px 12px; border-radius:10px; border:1px solid rgba(124,77,255,.5);
    background:linear-gradient(135deg, rgba(0,229,255,.15), rgba(124,77,255,.15));
    color:#fff; font-weight:700; cursor:pointer; white-space:nowrap;
  }
  .filename{color:var(--hint); font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1;}

  .actions{display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:12px; margin-top:2px; align-items:stretch;}
  @media (max-width:768px){ .actions{grid-template-columns:1fr; gap:12px} }
  .gifbtn{
    --glow-a:#00e5ff; --glow-b:#7c4dff;
    position:relative; display:block; width:100%; height:var(--gif-h);
    border:none; padding:0; cursor:pointer; background:transparent;
    border-radius:var(--tile-radius); overflow:hidden;
    box-shadow:0 0 8px rgba(0,0,0,.5);
    animation:glowPulse var(--pulse-speed) ease-in-out infinite alternate;
    transition:transform .12s ease, box-shadow .18s ease;
  }
  .gifbtn:active{transform:scale(.986)}
  .gifbtn:focus-visible{outline:none; box-shadow:0 0 0 3px rgba(0,229,255,.28)}
  .gifbtn::after{
    content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
    background:radial-gradient(240px 240px at var(--mx,50%) var(--my,50%), rgba(124,77,255,.22), transparent 60%);
    opacity:0; transform:scale(.9); transition:opacity .25s ease, transform .25s ease;
  }
  .gifbtn.rippling::after{opacity:1; transform:scale(1)}
  .gifbtn .frame{position:absolute; inset:var(--gif-inset); border-radius:calc(var(--tile-radius) - var(--gif-inset)/2);
    display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.4);}
  .gifbtn img{max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; object-position:center;
    display:block; border-radius:8px; filter:saturate(1.02) contrast(1.03); transition:transform .18s ease, filter .18s ease;}
  .gifbtn:hover img{transform:scale(1.02)}
  @keyframes glowPulse{
    0%{box-shadow:0 0 0 2px rgba(255,255,255,.03), 0 0 10px var(--glow-a), 0 0 16px var(--glow-a)}
    50%{box-shadow:0 0 0 2px rgba(255,255,255,.06), 0 0 18px var(--glow-b), 0 0 34px var(--glow-b)}
    100%{box-shadow:0 0 0 2px rgba(255,255,255,.03), 0 0 10px var(--glow-a), 0 0 16px var(--glow-a)}
  }
  .ring-cyan  { --glow-a:#00e5ff; --glow-b:#26fff2 }
  .ring-violet{ --glow-a:#7c4dff; --glow-b:#c07bff }
  .ring-duo   { --glow-a:#00e5ff; --glow-b:#7c4dff }

  /* Overlay + Modals */
  .overlay{position:fixed; inset:0; display:none; place-items:center; z-index:50;
    background:rgba(0,0,0,.55); backdrop-filter:blur(5px)}
  .run-frame{
    width:min(360px, 92vw); border-radius:18px; padding:14px;
    background:rgba(10,16,28,.85); border:1px solid rgba(0,229,255,.22);
    box-shadow:0 16px 42px rgba(0,0,0,.6), inset 0 0 0 1px rgba(124,77,255,.12);
    display:grid; gap:14px; justify-items:center; animation:popIn .25s ease;
  }
  @keyframes popIn{from{opacity:0; transform:translateY(6px) scale(.98)} to{opacity:1; transform:none}}
  .round-view{position:relative; width:180px; height:180px; border-radius:50%;
    display:grid; place-items:center; background:radial-gradient(140px 140px at 50% 45%, rgba(124,77,255,.10), rgba(0,229,255,.06));
    box-shadow:0 0 0 1px rgba(0,229,255,.25) inset, 0 12px 28px rgba(0,0,0,.45);}
  .round-ring{position:absolute; inset:-6px; border-radius:50%;
    --c1: rgba(0,229,255,.9); --c2: rgba(124,77,255,.9);
    background:conic-gradient(from 0deg, var(--c1), var(--c2), var(--c1));
    -webkit-mask: radial-gradient(circle 96px at 50% 50%, transparent 84px, #000 85px);
            mask: radial-gradient(circle 96px at 50% 50%, transparent 84px, #000 85px);
    filter:blur(.6px); opacity:.95; animation:spin 1.15s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  .round-glow{position:absolute; inset:8px; border-radius:50%;
    background:radial-gradient(closest-side, rgba(0,229,255,.22), transparent 70%); filter:blur(2px);}
  .run-gif{width:150px; height:150px; border-radius:50%; object-fit:cover; object-position:center;
    background:#0a0f18; box-shadow:0 0 0 2px rgba(255,255,255,.04) inset; animation:gifPulse 1.1s ease-in-out infinite;}
  @keyframes gifPulse{0%,100%{transform:scale(1)} 50%{transform:scale(1.03)}}
  .run-title{color:#d9f6ff; font-weight:800; font-size:14px; text-align:center; letter-spacing:.3px}
  .dots{display:inline-block; width:1.6ch; text-align:left; overflow:hidden; vertical-align:bottom; animation:dots 1.2s steps(4,end) infinite}
  @keyframes dots{0%{width:0} 33%{width:.6ch} 66%{width:1.2ch} 100%{width:1.6ch}}
  .timer{font-weight:800; color:#7cf1ff; font-size:13px}
  .bar{position:relative; width:100%; height:8px; border-radius:999px; overflow:hidden; background:rgba(255,255,255,.06); border:1px solid rgba(0,229,255,.18)}
  .bar::before{content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent, rgba(0,229,255,.6), transparent); transform:translateX(-100%); animation:shimmer 1.2s linear infinite;}
  @keyframes shimmer{to{transform:translateX(100%)}}
  .modal{position:fixed; inset:0; display:none; place-items:center; z-index:60; background:rgba(0,0,0,.55); backdrop-filter:blur(4px)}
  .modal-card{
    width:min(420px, 92vw); border-radius:18px; padding:18px;
    background:rgba(10,16,28,.94); border:1px solid rgba(0,229,255,.22);
    box-shadow:0 18px 44px rgba(0,0,0,.65); display:grid; gap:12px; justify-items:center; animation:popIn .25s ease;
  }
  .ok{color:#b7ffcc} .err{color:#ffd0d0}
  .tick, .cross{
    width:78px; height:78px; border-radius:50%; display:grid; place-items:center;
    background:radial-gradient(closest-side, rgba(0,229,255,.18), transparent);
    box-shadow:0 0 0 2px rgba(0,229,255,.18) inset;
  }
  .tick::before{content:""; width:36px; height:18px; border:4px solid #7CFFB2; border-top:none; border-right:none; transform:rotate(-45deg);}
  .cross::before, .cross::after{content:""; position:absolute; width:38px; height:4px; background:#ff7c7c; border-radius:2px;}
  .cross{position:relative} .cross::before{transform:rotate(45deg)} .cross::after{transform:rotate(-45deg)}
  .modal h3{margin:4px 0 0; color:#e9fcff; font-size:16px}
  .modal p{margin:0; color:#9fbdc6; font-size:13px; text-align:center}
  .btn{
    padding:10px 14px; border-radius:12px; border:1px solid rgba(0,229,255,.28);
    background:linear-gradient(135deg, rgba(0,229,255,.12), rgba(124,77,255,.12));
    color:#fff; font-weight:700; cursor:pointer;
  }

  /* âœ… Fixed Footer centered */
  .footer{
    position:fixed; left:0; right:0; bottom:0; z-index:3;
    display:flex; align-items:center; justify-content:center;
    padding:10px 14px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background: linear-gradient(180deg, rgba(6,10,18,0.05), rgba(6,10,18,0.58));
    border-top:1px solid rgba(0,229,255,.14);
    backdrop-filter: blur(8px);
    color:#cfefff; font-size:12px; letter-spacing:.3px; font-weight:700;
  }
  .badges{
  display:flex; align-items:center; gap:8px; flex-wrap:wrap;
}
.chip{
  display:inline-flex; align-items:center; gap:6px;
  font-size:11px; font-weight:700; color:#d9f6ff;
  padding:5px 8px; border-radius:999px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(0,229,255,.22);
  box-shadow:0 0 0 1px rgba(124,77,255,.10) inset;
  letter-spacing:.2px;
}
.chip-icon{
  width:20px; height:20px;
  filter:drop-shadow(0 0 5px rgba(0,229,255,.4));
  object-fit:contain;
}


</style>

<div class="stage">
  <video class="bg-video" autoplay muted loop playsinline>
    <source src="{{ url_for('static', filename='vv.mp4') }}" type="video/mp4">
  </video>
  <div class="veil"></div>

  <div class="shell">
    <div class="card">
      <div class="head">
        <div class="title"><span class="dot"></span> Initial Patent Relevance Ranking</div>
      <div class="badges">
  <!-- use your own Algorithm icon -->
  <span class="chip">
    <img src="{{ url_for('static', filename='Patentryx_logo.png') }}" class="chip-icon" alt="Algorithm">
    <b>Semantics</b>
  </span>

  <!-- use your own Model icon -->
  <span class="chip">
    <img src="{{ url_for('static', filename='Prion_logo.png') }}" class="chip-icon" alt="Model">
    <b>Model</b>
  </span>
</div>

      </div>

      <form id="initialForm" method="post" enctype="multipart/form-data" onsubmit="return false">
        <div class="row">
          <div class="field">
            <label for="project_code">Project Code</label>
            <input class="control" type="text" id="project_code" name="project_code" placeholder="e.g., MC101-092" required>
            <div class="help">Auto-fills from file name (text before first underscore).</div>
          </div>
          <div class="field">
            <label for="initial_file">Initial Dataset (.xlsx)</label>
            <div class="filebox">
              <label class="filebtn" for="initial_file">Choose File</label>
              <input type="file" id="initial_file" name="initial_file" accept=".xlsx" required>
              <div class="filename" id="filename">No file selected</div>
            </div>
            <div class="help">Example: <em>MC101-092_input.xlsx</em></div>
          </div>
        </div>

        <div class="field">
          <label for="abstract">Abstract</label>
          <textarea class="control" id="abstract" name="abstract" placeholder="Paste abstract hereâ€¦" required></textarea>
        </div>

        <div class="actions">
          <button type="button" class="gifbtn ring-cyan"
                  data-route="patentryx"
                  data-gif="{{ url_for('static', filename='Patentryx_logo.png') }}"
                  data-label="Patentryx">
            <div class="frame"><img src="{{ url_for('static', filename='Patentryx.gif') }}" alt="Patentryx"></div>
          </button>
          <button type="button" class="gifbtn ring-violet"
                  data-route="prioriq"
                  data-gif="{{ url_for('static', filename='Prion_logo.png') }}"
                  data-label="Prion">
            <div class="frame"><img src="{{ url_for('static', filename='Prion.gif') }}" alt="Prion"></div>
          </button>
          <button type="button" class="gifbtn ring-duo"
                  data-route="bothranking"
                  data-gif="{{ url_for('static', filename='booth.gif') }}"
                  data-label="Both Ranking">
            <div class="frame"><img src="{{ url_for('static', filename='boooth.gif') }}" alt="Both Ranking"></div>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Footer (fixed, centered text) -->
<div class="footer">Â© Datasolve Analytics Pvt Ltd 2025.</div>

<!-- RUN POPUP -->
<div class="overlay" id="runPopup" aria-hidden="true">
  <div class="run-frame" role="status" aria-live="polite">
    <div class="round-view">
      <div class="round-ring"></div>
      <div class="round-glow"></div>
      <img id="runGif" class="run-gif" src="" alt="Runningâ€¦">
    </div>
    <div class="run-title" id="runTitle">Running<span class="dots">...</span></div>
    <div class="timer" id="runTimer">00:00:00</div>
    <div class="bar" aria-hidden="true"></div>
  </div>
</div>

<!-- DONE POPUP -->
<div class="modal" id="doneModal" aria-hidden="true">
  <div class="modal-card">
    <div class="tick"></div>
    <h3>Completed</h3>
    <p id="doneMsg">Your job finished successfully.</p>
    <button class="btn" id="doneClose">Close</button>
  </div>
</div>

<!-- ERROR POPUP -->
<div class="modal" id="errModal" aria-hidden="true">
  <div class="modal-card">
    <div class="cross"></div>
    <h3>Error</h3>
    <p id="errMsg">Something went wrong.</p>
    <button class="btn" id="errClose">Close</button>
  </div>
</div>

<script>
  /* ðŸ”¹ Set tab title for this page */
  document.title = "PriorIQ - Initial Dataset";

  document.addEventListener('contextmenu', e => e.preventDefault());

  const fileInput = document.getElementById('initial_file');
  const fileNameEl = document.getElementById('filename');
  const projectCodeEl = document.getElementById('project_code');

  const runPopup = document.getElementById('runPopup');
  const runGif   = document.getElementById('runGif');
  const runTitle = document.getElementById('runTitle');
  const runTimer = document.getElementById('runTimer');

  const doneModal = document.getElementById('doneModal');
  const errModal  = document.getElementById('errModal');
  const doneClose = document.getElementById('doneClose');
  const errClose  = document.getElementById('errClose');
  let timerId = null, startTs = null;

  fileInput.addEventListener('change', function(){
    const f = this.files?.[0];
    if(!f){ fileNameEl.textContent = 'No file selected'; return; }
    fileNameEl.textContent = f.name;
    if(f.name.endsWith('.xlsx') && f.name.includes('_')){
      projectCodeEl.value = f.name.split('_')[0];
    }
  });

  document.querySelectorAll('.gifbtn').forEach(btn=>{
    btn.addEventListener('pointerdown', e=>{
      const rect = btn.getBoundingClientRect();
      btn.style.setProperty('--mx', (e.clientX - rect.left)+'px');
      btn.style.setProperty('--my', (e.clientY - rect.top)+'px');
      btn.classList.add('rippling');
      setTimeout(()=>btn.classList.remove('rippling'), 260);
    });
    btn.addEventListener('click', ()=> runRoute(btn));
  });

  function fmt(t){
    const s = Math.floor(t/1000);
    const hh = String(Math.floor(s/3600)).padStart(2,'0');
    const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  }

  function startTimer(){
    startTs = Date.now();
    runTimer.textContent = "00:00:00";
    if(timerId) clearInterval(timerId);
    timerId = setInterval(()=>{ runTimer.textContent = fmt(Date.now()-startTs); }, 1000);
  }

  function stopTimer(){
    if(timerId){ clearInterval(timerId); timerId = null; }
    return startTs ? fmt(Date.now()-startTs) : "00:00:00";
  }

  function show(el){ el.style.display = 'grid'; el.setAttribute('aria-hidden','false'); }
  function hide(el){ el.style.display = 'none'; el.setAttribute('aria-hidden','true'); }

  function showRunPopup(src, labelText){
    runGif.src = src || '';
    runTitle.innerHTML = (labelText ? `${labelText} running<span class="dots">...</span>` : 'Running<span class="dots">...</span>');
    startTimer();
    show(runPopup);
  }
  function hideRunPopup(){
    hide(runPopup);
    runGif.src = "";
    stopTimer();
  }

  function showDone(message){
    document.getElementById('doneMsg').textContent = message || 'Your job finished successfully.';
    show(doneModal);
  }
  function showErr(message){
    document.getElementById('errMsg').textContent = message || 'Something went wrong.';
    show(errModal);
  }

  doneClose.addEventListener('click', ()=> hide(doneModal));
  errClose.addEventListener('click',  ()=> hide(errModal));
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      hide(runPopup); hide(doneModal); hide(errModal);
    }
  });

  // ðŸ”„ UPDATED: unified error handling (popup) â€” only this function changed.
  async function runRoute(btn){
    const route = btn.dataset.route;
    const gif   = btn.dataset.gif;
    const label = btn.dataset.label || btn.querySelector('img')?.alt || route;
    const form  = document.getElementById('initialForm');

    if(!form.reportValidity()) return;

    const fd = new FormData(form);
    const allBtns = [...document.querySelectorAll('.gifbtn')];
    allBtns.forEach(b => b.disabled = true);

    showRunPopup(gif, label);

    try{
      const res = await fetch(`/${route}`, { method:'POST', body:fd });
      const ct  = res.headers.get('content-type') || '';
      const elapsed = stopTimer();
      setTimeout(()=>hideRunPopup(), 120);

      let data = null;

      if (ct.includes('application/json')) {
        try { data = await res.json(); } catch (_) { data = null; }
      } else {
        const t = await res.text();
        showErr(`Unexpected response (${res.status}). ${t.slice(0,200)}`);
        return;
      }

      // HTTP layer error -> popup
      if (!res.ok) {
        const msg = (data && (data.message || data.error || data.detail)) || `HTTP ${res.status}`;
        showErr(msg);
        return;
      }

      // App-level error contract -> popup
      if (data && data.status === 'error') {
        showErr(data.message || data.error || 'Unknown error');
        return;
      }

      // Legacy OK with error key
      if (data && data.error) {
        showErr(data.error);
        return;
      }

      // Success
      if (data && data.output_zip) {
        const filename = data.output_zip.split('/').pop();
        const a = document.createElement('a');
        a.href = `/download/${filename}`;
        a.setAttribute('download', filename);
        document.body.appendChild(a); a.click(); a.remove();

        showDone(`${label} completed in ${elapsed}. File: ${filename}`);
      } else {
        showErr('Unexpected JSON from server (missing output_zip).');
      }

    } catch(err){
      hideRunPopup();
      showErr(`Request failed: ${err?.message || err}`);
    } finally{
      allBtns.forEach(b => b.disabled = false);
    }
  }
</script>
{% endblock %}
