
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root{
    --bg1:#0f0c29; --bg2:#302b63; --bg3:#24243e;
    --glass:rgba(255,255,255,.12);
    --text:#eef2ff; --muted:#b8c1ec;
    --accent1:#22d3ee; --accent2:#0ea5e9; --accent3:#db2777; --accent4:#ea580c;
    --card:rgba(255,255,255,.08); --stroke:rgba(255,255,255,.18);
    --track:rgba(255,255,255,.22); --ticks:rgba(255,255,255,.35);
  }
  .theme-light{
    --bg1:#f8fafc; --bg2:#f1f5f9; --bg3:#e2e8f0;
    --glass:rgba(255,255,255,.7);
    --text:#0f172a; --muted:#475569;
    --accent1:#7c3aed; --accent2:#0ea5e9; --accent3:#db2777; --accent4:#ea580c;
    --card:#fff; --stroke:rgba(2,6,23,.08);
    --track:#e5e7eb; --ticks:#cbd5e1;
  }

  body{color:var(--text);background:
    radial-gradient(1200px 800px at 20% -10%, rgba(255,255,255,.06), transparent),
    linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3))}
  .wrap{max-width:1200px;margin:2rem auto;padding:0 1rem}

  .title{font-weight:800;letter-spacing:.3px;font-size:clamp(1.4rem,2.6vw,2.1rem)}
  .sub{color:var(--muted);font-size:.95rem}
  .pill{font-size:.8rem;padding:.45rem .7rem;border-radius:999px;border:1px solid var(--stroke);background:var(--card)}

  /* headline KPI cards */
  .headline-grid{ display:grid; gap:1rem; margin-top:1rem; margin-bottom:1.25rem; grid-template-columns: 1fr; }
  @media(min-width:900px){ .headline-grid{ grid-template-columns: repeat(3, 1fr); } }
  .headline{ position:relative;background:var(--glass);border:1px solid var(--stroke);
    border-radius:20px;padding:1rem 1.25rem;display:flex;align-items:center;justify-content:space-between;backdrop-filter: blur(12px); }
  .hcap{font-size:.95rem;color:var(--muted);font-weight:700}
  .hnum{font-size:clamp(2rem,4vw,2.6rem);font-weight:900;letter-spacing:.5px}
  .legend{color:var(--muted);font-size:.85rem;margin-top:.25rem}
  .dot{display:inline-block;width:.6rem;height:.6rem;border-radius:999px;margin-right:.5rem}

  /* small donut */
  .u-donut{ --size:78px; --thick:12px; --fg1:#22d3ee; --fg2:#38bdf8; width:var(--size); height:var(--size); flex:0 0 auto; position:relative; display:grid; place-items:center; }
  .u-donut svg{width:100%;height:100%}
  .u-donut .ticks{ fill:none; stroke:var(--ticks); stroke-width:1.6; stroke-dasharray:.7 3; opacity:.7; transform:rotate(-90deg); transform-origin:50% 50%; }
  .u-donut .track{ fill:none; stroke:var(--track); stroke-width:var(--thick); opacity:.6 }
  .u-donut .bar-shadow, .u-donut .bar{ fill:none; stroke:var(--fg2); stroke-width:var(--thick); stroke-linecap:round; transform:rotate(-90deg); transform-origin:50% 50%; stroke-dasharray:0 100; transition:stroke-dasharray .9s cubic-bezier(.2,.8,.2,1); filter: drop-shadow(0 0 6px var(--fg2)); }
  .u-donut .center{ position:absolute; display:flex; align-items:baseline; gap:.12rem; font-weight:900; font-size:1.05rem; letter-spacing:.3px; text-shadow:0 1px 0 rgba(0,0,0,.15); }
  .u-donut .center small{font-size:.7rem; opacity:.9; font-weight:800}

  /* grids */
  .quad-grid{ display:grid; gap:1.25rem; grid-template-columns: 1fr; }
  @media(min-width:992px){ .quad-grid{ grid-template-columns: 1fr 1fr; } }
  .quad{ background:var(--glass); border:1px solid var(--stroke); border-radius:18px; padding:1rem; }
  .quad.alt{ background:linear-gradient(135deg, rgba(255,255,255,.12), transparent); }
  .hbar{display:flex; align-items:center; gap:.6rem; margin-bottom:.75rem}
  .hbar .left{width:6px; height:28px; border-radius:6px}
  .hbar .text{font-weight:800; letter-spacing:.3px}
  .hbar .line{flex:1;height:6px;border-radius:999px;opacity:.8}
  .hbar.magenta .left{background:var(--accent3)} .hbar.magenta .line{background:var(--accent3)}
  .hbar.orange  .left{background:var(--accent4)} .hbar.orange  .line{background:var(--accent4)}

  .kpi-grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .card-kpi{ position:relative;background:var(--glass);border:1px solid var(--stroke);
    border-radius:18px;padding:1rem;backdrop-filter:blur(12px);transition:transform .12s, box-shadow .12s;cursor:pointer;overflow:hidden }
  .card-kpi:hover{transform:translateY(-2px);box-shadow:0 16px 34px rgba(0,0,0,.18)}
  .kcap{color:var(--muted);font-size:.92rem;margin-bottom:.35rem;font-weight:600}
  .knum{font-size:clamp(1.9rem,3.5vw,2.6rem);font-weight:900;letter-spacing:.5px}

  /* Venn */
  .venn { --size:260px; width:var(--size); height:calc(var(--size)*0.72); position:relative; margin:auto; }
  .venn svg{ width:100%; height:100%; }
  .venn .label { position:absolute; font-weight:800; font-size:.9rem; }
  .venn .lblA { left:8%;  top:8%;  color:#111; }
  .venn .lblB { right:8%; top:8%;  color:#111; }
  .venn .centerTxt{ position:absolute; bottom:-6px; left:0; right:0; text-align:center; font-size:.85rem; color:var(--muted); }

  /* percent bars */
  .pitem{margin:.35rem 0}
  .phead{display:flex;justify-content:space-between;font-size:.85rem;color:var(--muted)}
  .ptrack{height:12px;border-radius:999px;background:var(--track);overflow:hidden}
  .pfill{height:100%; width:0; border-radius:999px; transition:width .8s ease}

  /* tooltip */
  .chart-tip{
    position:fixed; z-index:9999; pointer-events:none;
    background:rgba(17,24,39,.92); color:#fff; border:1px solid rgba(255,255,255,.15);
    padding:.4rem .6rem; border-radius:.5rem; font-size:.8rem; box-shadow:0 8px 20px rgba(0,0,0,.35);
    transform:translate(-50%,-120%); white-space:nowrap; display:none;
  }
  .theme-light .chart-tip{ background:#111827; color:#fff; }

  /* ====== OVERLAY & TABLE (VERTICAL SCROLL ONLY) ====== */
  .top-sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none}
  .top-sheet{position:fixed;right:0;top:0;height:100%;width:min(900px,96%);background:var(--bg1);border-left:1px solid var(--stroke);box-shadow:0 0 40px rgba(0,0,0,.35);display:none;z-index:10000}
  .top-sheet header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--stroke)}
  .sheet-body{padding:12px 16px;height:calc(100% - 52px);overflow:hidden}  /* keep parent from scrolling */
  .tablewrap{
    border:1px solid var(--stroke);
    border-radius:14px;
    background:rgba(255,255,255,.04);
    height:100%;
    overflow-y:auto;   /* ‚úÖ vertical scroll */
    overflow-x:hidden; /* ‚ùå no horizontal scroll */
  }

  /* custom table that wraps text and fills width */
  .u-table{
    border-collapse:separate; border-spacing:0;
    width:100%; table-layout:fixed;        /* columns auto-fit container */
    color:var(--text); font-size:.94rem;
  }
  .u-table thead th{
    position:sticky; top:0; z-index:2;
    background:rgba(15,23,42,.9);
    backdrop-filter:blur(10px);
    color:#e5e7eb; font-weight:800;
    padding:.70rem .9rem;
    border-bottom:1px solid rgba(255,255,255,.10);
  }
  .u-table tbody td{
    padding:.55rem .9rem;
    border-bottom:1px solid rgba(255,255,255,.06);
    color:#dbeafe; vertical-align:middle;

    /* wrap long content so no X-scroll is needed */
    white-space:normal;
    overflow:hidden;
    text-overflow:ellipsis;
    word-break:break-word;
  }
  .u-table tbody tr:nth-child(odd){ background:rgba(255,255,255,.02); }
  .u-table tbody tr:hover{ background:rgba(34,211,238,.08); }
  .u-table thead th:first-child{border-top-left-radius:14px;}
  .u-table thead th:last-child {border-top-right-radius:14px;}
  .u-table tbody tr:last-child td:first-child{border-bottom-left-radius:14px;}
  .u-table tbody tr:last-child td:last-child {border-bottom-right-radius:14px;}
  .noscroll{overflow:hidden}
</style>

<div class="wrap">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div>
      <div class="title">Patentryx &amp; Prion ‚Äî Dashboard</div>
      <div class="sub">Live summary of <span class="badge text-bg-info">Mapped_Results</span></div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-sm btn-outline-light" id="themeToggle">üåó Theme</button>
      <span class="pill">Updated: <span id="now"></span></span>
    </div>
  </div>

  <!-- HEADLINE -->
  <section class="headline-grid">
    <div class="headline" data-metric="projects">
      <div>
        <div class="hcap">Total Number of Projects</div>
        <div class="hnum" data-animate="{{ total_projects|default(0) }}">0</div>
        <div class="legend"></div>
      </div>
    </div>

    <div class="headline" data-metric="patents">
      <div>
        <div class="hcap">Total Number of Patents</div>
        <div class="hnum" data-animate="{{ patents_count|default(0) }}">0</div>
        <div class="legend"></div>
      </div>
    </div>

    <div class="headline" data-metric="yes_no_no">
      <div>
        <div class="hcap">Patents Not in Initial Dataset</div>
        <div class="hnum" data-animate="{{ yes_no_no_total|default(0) }}">0</div>
        <div class="legend"></div>
      </div>
      <div class="u-donut" data-val="{{ yes_no_no_percentage|default(0) }}" data-fg1="#06b6d4" data-fg2="#22d3ee">
        <svg viewBox="0 0 120 120">
          <circle class="ticks" cx="60" cy="60" r="52"></circle>
          <circle class="track" cx="60" cy="60" r="48"></circle>
          <circle class="bar-shadow" cx="60" cy="60" r="48" pathLength="100"></circle>
          <circle class="bar" cx="60" cy="60" r="48" pathLength="100"></circle>
        </svg>
        <div class="center"><span>{{ yes_no_no_percentage|default(0) }}</span><small>%</small></div>
      </div>
    </div>
  </section>

  <!-- 2x2 -->
  <section class="quad-grid">
    <!-- Q1 -->
    <div class="quad">
      <div class="hbar magenta"><div class="left"></div><div class="text">Total Number of Patents Below 250</div><div class="line"></div></div>
      <div class="kpi-grid">
        <div class="card-kpi" data-metric="old_lt_250">
          <div class="kcap">Patentryx Rank Below 250</div>
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="knum" data-animate="{{ old_lt_250|default(0) }}">0</div>
              <div class="legend"></div>
            </div>
            <div class="u-donut" data-val="{{ old_rank_percentage|default(0) }}" data-fg1="#db2777" data-fg2="#f472b6">
              <svg viewBox="0 0 120 120"><circle class="ticks" cx="60" cy="60" r="52"></circle><circle class="track" cx="60" cy="60" r="48"></circle><circle class="bar-shadow" cx="60" cy="60" r="48" pathLength="100"></circle><circle class="bar" cx="60" cy="60" r="48" pathLength="100"></circle></svg>
              <div class="center"><span>{{ old_rank_percentage|default(0) }}</span><small>%</small></div>
            </div>
          </div>
        </div>

        <div class="card-kpi" data-metric="new_lt_250">
          <div class="kcap">Prion Rank Below 250</div>
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="knum" data-animate="{{ new_lt_250|default(0) }}">0</div>
              <div class="legend"></div>
            </div>
            <div class="u-donut" data-val="{{ new_rank_percentage|default(0) }}" data-fg1="#f97316" data-fg2="#fb923c">
              <svg viewBox="0 0 120 120"><circle class="ticks" cx="60" cy="60" r="52"></circle><circle class="track" cx="60" cy="60" r="48"></circle><circle class="bar-shadow" cx="60" cy="60" r="48" pathLength="100"></circle><circle class="bar" cx="60" cy="60" r="48" pathLength="100"></circle></svg>
              <div class="center"><span>{{ new_rank_percentage|default(0) }}</span><small>%</small></div>
            </div>
          </div>
        </div>

        <div class="card-kpi" data-metric="both_lt_250">
          <div class="kcap">Patentryx and Prion Rank Below 250 (AND)</div>
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="knum" data-animate="{{ both_lt_250|default(0) }}">0</div>
              <div class="legend"></div>
            </div>
            <div class="u-donut" data-val="{{ both_lt_250_percentage|default(0) }}" data-fg1="#7c3aed" data-fg2="#a78bfa">
              <svg viewBox="0 0 120 120"><circle class="ticks" cx="60" cy="60" r="52"></circle><circle class="track" cx="60" cy="60" r="48"></circle><circle class="bar-shadow" cx="60" cy="60" r="48" pathLength="100"></circle><circle class="bar" cx="60" cy="60" r="48" pathLength="100"></circle></svg>
              <div class="center"><span>{{ both_lt_250_percentage|default(0) }}</span><small>%</small></div>
            </div>
          </div>
        </div>

        <div class="card-kpi" data-metric="either_lt_250">
          <div class="kcap">Patentryx OR Prion Rank Below 250 (OR)</div>
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="knum" data-animate="{{ either_lt_250|default(0) }}">0</div>
              <div class="legend"></div>
            </div>
            <div class="u-donut" data-val="{{ either_lt_250_percentage|default(0) }}" data-fg1="#0ea5e9" data-fg2="#38bdf8">
              <svg viewBox="0 0 120 120"><circle class="ticks" cx="60" cy="60" r="52"></circle><circle class="track" cx="60" cy="60" r="48"></circle><circle class="bar-shadow" cx="60" cy="60" r="48" pathLength="100"></circle><circle class="bar" cx="60" cy="60" r="48" pathLength="100"></circle></svg>
              <div class="center"><span>{{ either_lt_250_percentage|default(0) }}</span><small>%</small></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Q2: Venn RAW -->
    <div class="quad alt">
      <div class="hbar magenta"><div class="left"></div><div class="text">Patents</div><div class="line"></div></div>
      <div class="venn" id="venn-total"
           data-total="{{ patents_count|default(0) }}"
           data-a="{{ old_lt_250|default(0) }}"
           data-b="{{ new_lt_250|default(0) }}"
           data-c="{{ both_lt_250|default(0) }}"
           data-d="{{ either_lt_250|default(0) }}">
        <div class="label lblA">A</div>
        <div class="label lblB">B</div>
        <div class="centerTxt">A = Patentryx &lt; 250, B = Prion &lt; 250, C = A ‚à© B, D = A ‚à™ B</div>
      </div>

      <div class="mt-2">
        <div class="pitem">
          <div class="phead"><span><span class="dot" style="background:var(--accent3)"></span>Patentryx Rank Below 250</span><span class="a-val">0</span></div>
          <div class="ptrack"><div class="pfill" id="bar-a" style="background:var(--accent3)"></div></div>
        </div>
        <div class="pitem">
          <div class="phead"><span><span class="dot" style="background:var(--accent4)"></span>Prion Rank Below 250</span><span class="b-val">0</span></div>
          <div class="ptrack"><div class="pfill" id="bar-b" style="background:var(--accent4)"></div></div>
        </div>
        <div class="pitem">
          <div class="phead"><span><span class="dot" style="background:var(--accent1)"></span>Patentryx and Prion Rank Below 250 (AND)</span><span class="c-val">0</span></div>
          <div class="ptrack"><div class="pfill" id="bar-c" style="background:var(--accent1)"></div></div>
        </div>
        <div class="pitem">
          <div class="phead"><span><span class="dot" style="background:var(--accent2)"></span>Patentryx OR Prion Rank Below 250 (OR)</span><span class="d-val">0</span></div>
          <div class="ptrack"><div class="pfill" id="bar-d" style="background:var(--accent2)"></div></div>
        </div>
      </div>
    </div>

    <!-- Q3: yes_no='No' KPIs -->
    <div class="quad">
      <div class="hbar orange"><div class="left"></div><div class="text">Patents Not in Initial Dataset Below 250</div><div class="line"></div></div>
      <div class="kpi-grid">
        <div class="card-kpi" data-metric="old_lt_250_no">
          <div class="kcap">Patentryx Not in Initial Dataset</div>
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="knum" data-animate="{{ old_lt_250_no|default(0) }}">0</div>
              <div class="legend"></div>
            </div>
            <div class="u-donut" data-val="{{ old_lt_250_yes_no_percentage|default(0) }}" data-fg1="#db2777" data-fg2="#f472b6">
              <svg viewBox="0 0 120 120"><circle class="ticks" cx="60" cy="60" r="52"></circle><circle class="track" cx="60" cy="60" r="48"></circle><circle class="bar-shadow" cx="60" cy="60" r="48" pathLength="100"></circle><circle class="bar" cx="60" cy="60" r="48" pathLength="100"></circle></svg>
              <div class="center"><span>{{ old_lt_250_yes_no_percentage|default(0) }}</span><small>%</small></div>
            </div>
          </div>
        </div>

        <div class="card-kpi" data-metric="new_lt_250_no">
          <div class="kcap">Prion Not in Initial Dataset</div>
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="knum" data-animate="{{ new_lt_250_no|default(0) }}">0</div>
              <div class="legend"></div>
            </div>
            <div class="u-donut" data-val="{{ new_lt_250_yes_no_percentage|default(0) }}" data-fg1="#f97316" data-fg2="#fb923c">
              <svg viewBox="0 0 120 120"><circle class="ticks" cx="60" cy="60" r="52"></circle><circle class="track" cx="60" cy="60" r="48"></circle><circle class="bar-shadow" cx="60" cy="60" r="48" pathLength="100"></circle><circle class="bar" cx="60" cy="60" r="48" pathLength="100"></circle></svg>
              <div class="center"><span>{{ new_lt_250_yes_no_percentage|default(0) }}</span><small>%</small></div>
            </div>
          </div>
        </div>

        <div class="card-kpi" data-metric="both_lt_250_no">
          <div class="kcap">Patentryx and Prion Not in Initial Dataset</div>
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="knum" data-animate="{{ both_lt_250_no|default(0) }}">0</div>
              <div class="legend"></div>
            </div>
            <div class="u-donut" data-val="{{ both_lt_250_yes_no_percentage|default(0) }}" data-fg1="#a855f7" data-fg2="#c084fc">
              <svg viewBox="0 0 120 120"><circle class="ticks" cx="60" cy="60" r="52"></circle><circle class="track" cx="60" cy="60" r="48"></circle><circle class="bar-shadow" cx="60" cy="60" r="48" pathLength="100"></circle><circle class="bar" cx="60" cy="60" r="48" pathLength="100"></circle></svg>
              <div class="center"><span>{{ both_lt_250_yes_no_percentage|default(0) }}</span><small>%</small></div>
            </div>
          </div>
        </div>

        <div class="card-kpi" data-metric="either_lt_250_no">
          <div class="kcap">Patentryx OR Prion Not in Initial Dataset</div>
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="knum" data-animate="{{ either_lt_250_no|default(0) }}">0</div>
              <div class="legend"></div>
            </div>
            <div class="u-donut" data-val="{{ either_lt_250_yes_no_percentage|default(0) }}" data-fg1="#0ea5e9" data-fg2="#38bdf8">
              <svg viewBox="0 0 120 120"><circle class="ticks" cx="60" cy="60" r="52"></circle><circle class="track" cx="60" cy="60" r="48"></circle><circle class="bar-shadow" cx="60" cy="60" r="48" pathLength="100"></circle><circle class="bar" cx="60" cy="60" r="48" pathLength="100"></circle></svg>
              <div class="center"><span>{{ either_lt_250_yes_no_percentage|default(0) }}</span><small>%</small></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Q4: Venn RAW (Not in Initial Dataset) -->
    <div class="quad alt">
      <div class="hbar orange"><div class="left"></div><div class="text">Patents Not in Initial Dataset</div><div class="line"></div></div>

      <div class="venn" id="venn-no"
           data-total="{{ yes_no_no_total|default(0) }}"
           data-a="{{ old_lt_250_no|default(0) }}"
           data-b="{{ new_lt_250_no|default(0) }}"
           data-c="{{ both_lt_250_no|default(0) }}"
           data-d="{{ either_lt_250_no|default(0) }}">
        <div class="label lblA">A</div>
        <div class="label lblB">B</div>
        <div class="centerTxt">A = Patentryx &lt; 250, B = Prion &lt; 250, C = A ‚à© B, D = A ‚à™ B</div>
      </div>

      <div class="mt-2">
        <div class="pitem">
          <div class="phead"><span><span class="dot" style="background:var(--accent3)"></span>Patentryx Rank Below 250</span><span class="a-val-no">0</span></div>
          <div class="ptrack"><div class="pfill" id="bar-a-no" style="background:var(--accent3)"></div></div>
        </div>
        <div class="pitem">
          <div class="phead"><span><span class="dot" style="background:var(--accent4)"></span>Prion Rank Below 250</span><span class="b-val-no">0</span></div>
          <div class="ptrack"><div class="pfill" id="bar-b-no" style="background:var(--accent4)"></div></div>
        </div>
        <div class="pitem">
          <div class="phead"><span><span class="dot" style="background:var(--accent1)"></span>Patentryx and Prion Rank Below 250 (AND)</span><span class="c-val-no">0</span></div>
          <div class="ptrack"><div class="pfill" id="bar-c-no" style="background:var(--accent1)"></div></div>
        </div>
        <div class="pitem">
          <div class="phead"><span><span class="dot" style="background:var(--accent2)"></span>D (A ‚à™ B)</span><span class="d-val-no">0</span></div>
          <div class="ptrack"><div class="pfill" id="bar-d-no" style="background:var(--accent2)"></div></div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Overlay -->
<div class="top-sheet-backdrop" id="sheetBackdrop" aria-hidden="true"></div>
<div class="top-sheet" id="topSheet" role="dialog" aria-modal="true" aria-hidden="true" style="display:none;">
  <header>
    <h5 id="sheetTitle" class="mb-0">Details</h5>
    <button class="btn btn-sm btn-outline-light" id="closeSheet" type="button">Close</button>
  </header>
  <div class="sheet-body">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div id="sheetCount" class="sub"></div>
    </div>
    <div class="tablewrap">
      <table class="u-table" id="dataTable"></table>
    </div>
  </div>
</div>

<script>
  // timestamp + theme
  document.getElementById('now').textContent = new Date().toLocaleString();
  document.getElementById('themeToggle').onclick = () =>
    document.documentElement.classList.toggle('theme-light');

  // number animation
  document.querySelectorAll('[data-animate]').forEach(el=>{
    const end=+el.getAttribute('data-animate')||0, dur=900, t0=performance.now();
    (function tick(t){const p=Math.min((t-t0)/dur,1); el.textContent=Math.round(end*p).toLocaleString(); if(p<1)requestAnimationFrame(tick)})(t0);
  });

  // donut animate
  document.querySelectorAll('.u-donut').forEach((d,i)=>{
    const v=Math.max(0,Math.min(100,parseFloat(d.dataset.val)||0));
    const svg=d.querySelector('svg'), bar=svg.querySelector('.bar'), sh=svg.querySelector('.bar-shadow');
    const fg1=d.dataset.fg1||'#22d3ee', fg2=d.dataset.fg2||fg1;
    const NS='http://www.w3.org/2000/svg';
    const defs=document.createElementNS(NS,'defs');
    const grad=document.createElementNS(NS,'linearGradient'); const gid='grad-'+i;
    grad.setAttribute('id',gid); grad.setAttribute('x1','0%'); grad.setAttribute('y1','0%'); grad.setAttribute('x2','100%'); grad.setAttribute('y2','100%');
    const s1=document.createElementNS(NS,'stop'); s1.setAttribute('offset','0%');  s1.setAttribute('stop-color',fg1);
    const s2=document.createElementNS(NS,'stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color',fg2);
    grad.appendChild(s1); grad.appendChild(s2); defs.appendChild(grad); svg.insertBefore(defs, svg.firstChild);
    bar.setAttribute('stroke',`url(#${gid})`);
    requestAnimationFrame(()=>{ sh.setAttribute('pathLength','100'); bar.setAttribute('pathLength','100'); sh.style.strokeDasharray = `${v} ${100-v}`; bar.style.strokeDasharray = `${v} ${100-v}`; });
  });

  // tooltip
  const tip=document.createElement('div'); tip.className='chart-tip'; document.body.appendChild(tip);
  function showTip(text,x,y){ tip.textContent=text; tip.style.left=x+'px'; tip.style.top=y+'px'; tip.style.display='block'; }
  function hideTip(){ tip.style.display='none'; }

  // overlay helpers
  const backdrop=document.getElementById('sheetBackdrop'), sheet=document.getElementById('topSheet'),
        dataTable=document.getElementById('dataTable'), sheetTitle=document.getElementById('sheetTitle'),
        sheetCount=document.getElementById('sheetCount');
  function openSheet(){sheet.style.display='block';backdrop.style.display='block';document.body.classList.add('noscroll')}
  function closeSheet(){sheet.style.display='none';backdrop.style.display='none';dataTable.innerHTML='';document.body.classList.remove('noscroll')}
  document.getElementById('closeSheet').addEventListener('click', closeSheet);
  backdrop.addEventListener('click', closeSheet);
  document.addEventListener('keydown',e=>{if(e.key==='Escape') closeSheet()});

  function renderTable(cols, rows){
    const thead='<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
    const body=rows.map(r=>'<tr>'+cols.map(c=>`<td>${(r[c]??'').toString()}</td>`).join('')+'</tr>').join('');
    // presentation-only class (logic unchanged)
    dataTable.className='u-table';
    dataTable.innerHTML=thead+'<tbody>'+body+'</tbody>';
  }

  async function fetchAndShow(metric,title){
    try{
      const res=await fetch(`/dashboard_data?metric=${encodeURIComponent(metric)}`);
      const data=await res.json();
      if(data.error) throw new Error(data.error);
      sheetTitle.textContent=title;
      sheetCount.textContent=`Count: ${(data.count||0).toLocaleString()}`;
      renderTable(data.columns,data.rows);
      openSheet();
    }catch(err){ alert('Failed to load data: '+err.message); }
  }

  // click -> details
  document.querySelectorAll('[data-metric]').forEach(card=>{
    card.addEventListener('click',()=>{
      const metric=card.getAttribute('data-metric');
      const title=card.querySelector('.kcap,.hcap')?.textContent?.trim()||'Details';
      fetchAndShow(metric,title);
    });
  });

  /* ===== Proportional Venn with colored borders + hover counts ===== */
  function buildVenn(containerSelector, barIds, valueSelectors){
    const el=document.querySelector(containerSelector); if(!el) return;
    const total = Math.max(0,+el.dataset.total||0);
    const A = Math.max(0,+el.dataset.a||0);
    const B = Math.max(0,+el.dataset.b||0);
    const C = Math.max(0,+el.dataset.c||0); // intersection
    const D = Math.max(0,+el.dataset.d||0); // union

    const Aonly = Math.max(0, A - C);
    const Bonly = Math.max(0, B - C);

    const NS='http://www.w3.org/2000/svg';
    const svg=document.createElementNS(NS,'svg');
    svg.setAttribute('viewBox','0 0 320 220');

    // scale radii ~ sqrt(value) so area ~ value
    const maxVal = Math.max(A, B, 1);
    const scale = 90 / Math.sqrt(maxVal);
    const rA = Math.max(18, Math.sqrt(A||1) * scale);
    const rB = Math.max(18, Math.sqrt(B||1) * scale);

    // center positions ‚Äî push closer as C grows
    const overlapFactor = (A && B) ? Math.min(1, Math.max(0, C / Math.min(A,B))) : 0;
    const sep = 120 - overlapFactor * 70; // 120px down to ~50px
    const cx = 160, cy = 110;
    const cxA = cx - sep/2, cxB = cx + sep/2;

    // circles with colored borders
    const left = document.createElementNS(NS,'circle');
    left.setAttribute('cx',cxA); left.setAttribute('cy',cy); left.setAttribute('r',rA);
    left.setAttribute('fill','#fde68a'); left.setAttribute('fill-opacity','.8');
    left.setAttribute('stroke','#f97316'); left.setAttribute('stroke-width','4'); // orange
    left.style.pointerEvents = 'stroke'; // hover on border

    const right = document.createElementNS(NS,'circle');
    right.setAttribute('cx',cxB); right.setAttribute('cy',cy); right.setAttribute('r',rB);
    right.setAttribute('fill','#93c5fd'); right.setAttribute('fill-opacity','.8');
    right.setAttribute('stroke','#facc15'); right.setAttribute('stroke-width','4'); // yellow
    right.style.pointerEvents = 'stroke';

    svg.appendChild(left); svg.appendChild(right);

    // center green ring to represent intersection border
    const inter = document.createElementNS(NS,'circle');
    inter.setAttribute('cx',(cxA+cxB)/2); inter.setAttribute('cy',cy);
    inter.setAttribute('r', Math.min(rA, rB) * 0.72);
    inter.setAttribute('fill','none');
    inter.setAttribute('stroke','#22c55e'); inter.setAttribute('stroke-width','6'); // green
    inter.style.pointerEvents = 'stroke';
    svg.appendChild(inter);

    // numbers
    const tx=(x,y,t,col)=>{
      const n=document.createElementNS(NS,'text');
      n.setAttribute('x',x); n.setAttribute('y',y); n.setAttribute('text-anchor','middle');
      n.setAttribute('font-weight','900'); n.setAttribute('font-size','18'); n.setAttribute('fill',col);
      n.textContent=t; return n;
    };
    svg.appendChild(tx(cxA - rA*0.45, cy, (A - C).toLocaleString(), '#f97316')); // A only
    svg.appendChild(tx(cxB + rB*0.45, cy, (B - C).toLocaleString(), '#facc15')); // B only
    svg.appendChild(tx((cxA+cxB)/2, cy+8, C.toLocaleString(), '#22c55e'));      // C
    svg.appendChild(tx(cx, 205, `Patentryx OR Prion = ${D.toLocaleString()}`, '#e5e7eb'));

    const glow = (shape, color, label) => {
      shape.addEventListener('mouseenter', e => {
        shape.style.filter = `drop-shadow(0 0 12px ${color})`;
        showTip(label, e.clientX+14, e.clientY-12);
      });
      shape.addEventListener('mousemove', e => showTip(label, e.clientX+14, e.clientY-12));
      shape.addEventListener('mouseleave', () => { shape.style.filter='none'; hideTip(); });
    };
    glow(left,  '#f97316', `250 Below Patentryx Ranked : ${A.toLocaleString()}`);
    glow(right, '#facc15', `250 Below Prion Ranked : ${B.toLocaleString()}`);
    glow(inter, '#22c55e', `250 Below Patentryx and Prion Ranked: ${C.toLocaleString()}`);

    el.innerHTML=''; el.appendChild(svg);

    // percent bars + labels
    const pct = v => total? (v/total*100) : 0;
    const setBar = (id, pctVal, labelSel, countVal) => {
      const bar=document.querySelector(id);
      if(bar){ requestAnimationFrame(()=> bar.style.width = pctVal.toFixed(2)+'%'); }
      const lbl=document.querySelector(labelSel);
      if(lbl){ lbl.textContent = `${Math.round(pctVal)}% (${(countVal||0).toLocaleString()})`; }
    };
    setBar(barIds.a, pct(A),  valueSelectors.a, A);
    setBar(barIds.b, pct(B),  valueSelectors.b, B);
    setBar(barIds.c, pct(C),  valueSelectors.c, C);
    setBar(barIds.d, pct(D),  valueSelectors.d, D);
  }

  // Build both Venns
  buildVenn('#venn-total',
    {a:'#bar-a', b:'#bar-b', c:'#bar-c', d:'#bar-d'},
    {a:'.a-val', b:'.b-val', c:'.c-val', d:'.d-val'}
  );
  buildVenn('#venn-no',
    {a:'#bar-a-no', b:'#bar-b-no', c:'#bar-c-no', d:'#bar-d-no'},
    {a:'.a-val-no', b:'.b-val-no', c:'.c-val-no', d:'.d-val-no'}
  );
</script>

